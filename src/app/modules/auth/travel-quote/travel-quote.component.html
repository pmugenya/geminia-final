 <!-- Main container -->
<div class="min-h-screen w-full bg-gray-50">
    <!-- Header -->
    <header class="sticky top-0 z-10 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6">
            <div class="flex flex-col items-center justify-between gap-4 py-3 sm:flex-row sm:gap-0 sm:py-4">
                <!-- Logo and Tagline -->
                <div class="flex items-center gap-3 sm:gap-4">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcROTKn0j9cVpA67LPdjPeYBR3KnWiwP1gsM3cS27rca-7m8BgvgUylY4uhBnOnVnXFx8Is&usqp=CAU" alt="Geminia Logo" class="h-8 w-auto sm:h-10" />
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800 sm:text-xl">Geminia Travel</h1>
                        <p class="text-xs font-semibold tracking-wide text-gray-500">Think Insurance ... Think Geminia</p>
                    </div>
                </div>

                <!-- User Info and Actions -->
                <div class="flex flex-wrap items-center justify-center gap-4 sm:flex-nowrap">
                    <!-- Display User Info if Logged In -->
                    <div *ngIf="isLoggedIn" class="flex items-center gap-3 text-sm">
                        <div class="text-right">
                            <span class="font-semibold text-gray-800">{{ user?.name }}</span>
                            <span class="block text-xs text-gray-500">{{ user?.userType | titlecase }}</span>
                        </div>
                        <button (click)="logout()" class="flex items-center gap-2 rounded-md border border-red-500 bg-red-50 px-3 py-2 text-sm font-medium text-red-600 transition-colors duration-200 hover:bg-red-100" title="Logout">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </div>

                    <!-- Close Button -->
                    <button (click)="closeForm()" class="flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors duration-200 hover:bg-gray-50" title="Close">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="p-6">
        <div class="mx-auto max-w-7xl">
            <!-- Progress Steps -->
            <div class="mb-8">
                 <div class="flex items-center">
                    <div class="flex items-center" [class.text-geminia-blue]="currentStep >= 1" [class.text-gray-500]="currentStep < 1">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-geminia-blue]="currentStep >= 1" [class.text-white]="currentStep >= 1" [class.bg-gray-300]="currentStep < 1">1</div>
                        <span class="ml-2 text-sm font-medium">Quote & Select Plan</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-geminia-blue]="currentStep > 1" [class.bg-gray-300]="currentStep <= 1"></div>
                    <div class="flex items-center" [class.text-geminia-blue]="currentStep >= 2" [class.text-gray-500]="currentStep < 2">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-geminia-blue]="currentStep >= 2" [class.text-white]="currentStep >= 2" [class.bg-gray-300]="currentStep < 2">2</div>
                        <span class="ml-2 text-sm font-medium">Traveler Details</span>
                    </div>
                    <div class="mx-4 h-px flex-1" [class.bg-geminia-blue]="currentStep > 2" [class.bg-gray-300]="currentStep <= 2"></div>
                    <div class="flex items-center" [class.text-geminia-blue]="currentStep >= 3" [class.text-gray-500]="currentStep < 3">
                        <div class="flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium" [class.bg-geminia-blue]="currentStep >= 3" [class.text-white]="currentStep >= 3" [class.bg-gray-300]="currentStep < 3">3</div>
                        <span class="ml-2 text-sm font-medium">Review & Pay</span>
                    </div>
                </div>
            </div>

            <!-- Content Container -->
            <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                <!-- Left Column: Forms -->
                <div [ngClass]="{'lg:col-span-3': currentStep === 1, 'lg:col-span-2': currentStep > 1}">
                    <!-- Step 1: Quote Form & Plan Selection -->
                    <div *ngIf="currentStep === 1" class="step-content">
                        <form [formGroup]="quoteForm">
                            <div class="rounded-lg bg-white p-6 shadow-sm">
                                <h2 class="mb-2 text-2xl font-semibold text-gray-900">Get Your Travel Insurance Quote</h2>
                                <p class="mb-6 text-gray-600">Tell us about your trip to see available plans and pricing.</p>
                                <div class="grid grid-cols-1 gap-x-6 gap-y-4">
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Cover Period<span class="text-red-500">*</span></label>
                                        <select formControlName="duration" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2">
                                            <option value="" disabled>Select duration</option>
                                            <option *ngFor="let d of standardDurations" [value]="d.value">{{ d.label }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
    
                            <div *ngIf="qf.duration.value" class="mt-8">
                                <h3 class="mb-4 text-xl font-semibold text-gray-800">Select a Plan</h3>
                                <div class="grid grid-cols-3 gap-6">
                                    <div *ngFor="let plan of displayedPlans" class="plan-card" [ngClass]="{'selected-plan': qf.plan.value === plan.id}">
                                        <div class="p-6">
                                            <div class="plan-price">
                                                <span class="price-amount">KES {{ (plan.priceUSD * USD_TO_KES_RATE) | number:'1.0-0' }}</span>
                                                <div class="price-period">per person</div>
                                            </div>
                                            <div class="plan-tags">
                                                <span *ngFor="let tag of plan.tags" class="plan-tag">{{ tag }}</span>
                                            </div>
                                            <ul class="plan-benefits">
                                                <li *ngFor="let benefit of plan.benefits" class="benefit-item">
                                                    <mat-icon class="benefit-icon included">check_circle</mat-icon>
                                                    <div class="benefit-text">
                                                        <div class="benefit-name">{{ benefit.name }}</div>
                                                        <div class="benefit-details">
                                                            <span *ngIf="benefit.limit" class="benefit-limit">{{ benefit.limit }}</span>
                                                            <span *ngIf="benefit.notes" class="benefit-notes">{{ benefit.notes }}</span>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                        <label class="p-6 pt-0 mt-auto">
                                            <input type="radio" formControlName="plan" [value]="plan.id" class="sr-only"/>
                                            <span class="select-button">Select Plan</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="mt-8 flex justify-end">
                            <button (click)="nextStep()" [disabled]="quoteForm.invalid" class="btn-primary rounded-md px-8 py-3 font-medium">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: Traveler Details -->
                    <div *ngIf="currentStep === 2" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-2 text-2xl font-semibold text-gray-900">Traveler Details</h2>
                        <p class="mb-6 text-gray-600">Please provide contact info and details for all travelers.</p>
                        
                        <form [formGroup]="travelerDetailsForm">
                            <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-gray-800">Primary Contact & Trip Info</h3>
                            <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Email Address<span class="text-red-500">*</span></label>
                                   <input type="email" formControlName="email" (input)="handleInputChange($event, 'email')" (blur)="trimInput($event, 'email')" (keydown)="preventLeadingSpace($event)" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                    <div *ngIf="tdf.email.invalid && (tdf.email.dirty || tdf.email.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.email.errors?.['required']">Email address is required.</div>
                                       <div *ngIf="tdf.email.errors?.['email']">Please enter a valid email address.</div>
                                       <div *ngIf="tdf.email.errors?.['whitespace']">Email cannot contain only whitespace.</div>
                                   </div>
                               </div>
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Phone Number<span class="text-red-500">*</span></label>
                                   <input type="tel" formControlName="phoneNumber" (input)="handleInputChange($event, 'phoneNumber')" (blur)="trimInput($event, 'phoneNumber')" (keydown)="preventLeadingSpace($event)" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" placeholder="+254712345678" />
                                    <div *ngIf="tdf.phoneNumber.invalid && (tdf.phoneNumber.dirty || tdf.phoneNumber.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.phoneNumber.errors?.['required']">Phone number is required.</div>
                                       <div *ngIf="tdf.phoneNumber.errors?.['invalidPhoneNumber']">Please enter a valid phone number (9-15 digits).</div>
                                       <div *ngIf="tdf.phoneNumber.errors?.['whitespace']">Phone number cannot contain only whitespace.</div>
                                   </div>
                               </div>
                               <div>
                                   <label class="mb-2 block text-sm font-medium text-gray-700">Number of Travelers<span class="text-red-500">*</span></label>
                                   <input type="number" formControlName="numTravelers" min="1" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                   <div *ngIf="tdf.numTravelers.invalid && (tdf.numTravelers.dirty || tdf.numTravelers.touched)" class="mt-1 text-xs text-red-500">
                                       <div *ngIf="tdf.numTravelers.errors?.['required']">Number of travelers is required.</div>
                                       <div *ngIf="tdf.numTravelers.errors?.['min']">At least one traveler is required.</div>
                                   </div>
                               </div>
                            </div>

                            <div class="mt-8" formArrayName="travelers">
                                <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-gray-800">Traveler Information</h3>

                                <!-- NEW: Duplicate Traveler Error Message -->
                                <div *ngIf="travelers.hasError('duplicateTraveler') && travelers.touched" class="mb-4 rounded-md bg-red-50 p-3 text-center text-sm text-red-600">
                                    Error: Each traveler must have a unique combination of full name and date of birth.
                                </div>
                                
                                <div *ngFor="let travelerGroup of travelers.controls; let i = index" [formGroupName]="i" class="mb-6 rounded-md border bg-gray-50/50 p-4">
                                    <h4 class="mb-4 font-medium text-gray-700">
                                        {{ i === 0 ? 'Primary Traveler' : 'Traveler ' + (i + 1) }}
                                    </h4>
                                    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                        <div>
                                            <label class="mb-2 block text-sm font-medium text-gray-700">Full Name<span class="text-red-500">*</span></label>
                                            <input type="text" formControlName="fullName" (blur)="trimTravelerInput($event, i, 'fullName')" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                            <div *ngIf="travelerGroup.get('fullName')?.invalid && (travelerGroup.get('fullName')?.dirty || travelerGroup.get('fullName')?.touched)" class="mt-1 text-xs text-red-500">
                                                <div *ngIf="travelerGroup.get('fullName')?.errors?.['required']">Full name is required.</div>
                                                <div *ngIf="travelerGroup.get('fullName')?.errors?.['invalidName']">Please enter at least two names (e.g., John Doe).</div>
                                                <div *ngIf="travelerGroup.get('fullName')?.errors?.['whitespace']">Name cannot contain only whitespace.</div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="mb-2 block text-sm font-medium text-gray-700">Date of Birth<span class="text-red-500">*</span></label>
                                            <input type="date" formControlName="dob" class="w-full rounded-md border border-gray-300 bg-white px-3 py-2" />
                                            <div *ngIf="travelerGroup.get('dob')?.invalid && (travelerGroup.get('dob')?.dirty || travelerGroup.get('dob')?.touched)" class="mt-1 text-xs text-red-500">
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['required']">Date of birth is required.</div>
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['futureDate']">Date of birth cannot be in the future.</div>
                                                <div *ngIf="travelerGroup.get('dob')?.errors?.['tooOld']">Please enter a valid year.</div>
                                            </div>
                                            <!-- NEW: Minor Declaration -->
                                            <div *ngIf="travelerGroup.get('dob')?.valid && getAge(travelerGroup.get('dob')?.value) < 18" class="mt-1 text-xs font-semibold text-blue-600">
                                                (This traveler is a minor)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex items-center">
                               <input type="checkbox" formControlName="winterSports" id="winterSports" class="h-4 w-4 rounded border-gray-300 text-geminia-blue focus:ring-geminia-blue" />
                               <label for="winterSports" class="ml-2 text-sm text-gray-700">Add Winter Sports cover (Optional Surcharge)</label>
                           </div>
                       </form>
                    </div>

                    <!-- Step 3: Review & Pay -->
                    <div *ngIf="currentStep === 3" class="step-content rounded-lg bg-white p-6 shadow-sm">
                        <h2 class="mb-6 text-2xl font-semibold text-gray-900">Review Your Quote</h2>
                        <div class="review-section">
                            <h4>Trip Details</h4>
                            <div class="review-grid">
                                <span class="label">Plan</span><span class="value">{{ selectedPlanDetails?.name }}</span>
                                <span class="label">Cover Period</span><span class="value">{{ getDurationText(quoteForm.value.duration) }}</span>
                                <span class="label">Travelers</span><span class="value">{{ travelerDetailsForm.value.numTravelers }}</span>
                            </div>

                            <h4>Contact Information</h4>
                            <div class="review-grid">
                                <span class="label">Email</span><span class="value">{{ travelerDetailsForm.value.email }}</span>
                                <span class="label">Phone</span><span class="value">{{ travelerDetailsForm.value.phoneNumber }}</span>
                            </div>

                             <div class="mt-4">
                                <h4 class="font-semibold text-gray-800">Insured Travelers</h4>
                                <ul class="mt-2 space-y-1">
                                    <li *ngFor="let traveler of travelerDetailsForm.value.travelers" class="text-gray-600">
                                        {{ traveler.fullName }} (DOB: {{ traveler.dob | date:'longDate' }})
                                    </li>
                                </ul>
                            </div>

                            <h4 class="mt-8">Full Plan Benefits</h4>
                            <table *ngIf="selectedPlanDetails" class="benefit-table">
                                <thead>
                                    <tr>
                                        <th>Benefit</th>
                                        <th>Limit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container *ngFor="let benefit of selectedPlanDetails.benefits">
                                        <tr *ngIf="benefit.included">
                                            <td>{{ benefit.name }}</td>
                                            <td>{{ benefit.limit }} <span *ngIf="benefit.notes">({{benefit.notes}})</span></td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Premium Summary & Navigation (HIDDEN in Step 1) -->
                <div *ngIf="currentStep > 1" class="lg:col-span-1">
                    <div class="sticky top-24 rounded-lg bg-white p-6 shadow-sm">
                        <h3 class="mb-4 text-lg font-semibold text-gray-900">Premium Summary</h3>
                                                <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span>Subtotal (USD)</span><span class="font-bold">$ {{ premium.subtotalUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.groupDiscountUSD > 0" class="flex justify-between text-green-600">
                                <span>Group Discount ({{ premium.groupDiscountPercentage }}%)</span>
                                <span class="font-bold">- $ {{ premium.groupDiscountUSD | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.ageSurchargeUSD !== 0" class="flex justify-between" [ngClass]="{ 'text-red-500': premium.ageSurchargeUSD > 0, 'text-green-600': premium.ageSurchargeUSD < 0 }">
                                <span>Age-Based Adjustment</span>
                                <span class="font-bold">{{ premium.ageSurchargeUSD > 0 ? '+' : '-' }} $ {{ abs(premium.ageSurchargeUSD) | number: '1.2-2' }}</span>
                            </div>
                            <div *ngIf="premium.winterSportsSurchargeUSD > 0" class="flex justify-between text-red-500">
                                <span>Winter Sports Surcharge</span>
                                <span class="font-bold">+ $ {{ premium.winterSportsSurchargeUSD | number: '1.2-2' }}</span>
                            </div>
                            <div class="my-2 border-t border-gray-300"></div>
                            <div class="flex justify-between text-gray-700">
                                <span>PHCF (0.25%)</span><span class="font-bold">KES {{ premium.phcf | number: '1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between text-gray-700">
                                <span>Training Levy (0.2%)</span><span class="font-bold">KES {{ premium.trainingLevy | number: '1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between text-gray-700">
                                <span>Stamp Duty</span><span class="font-bold">KES {{ premium.stampDuty | number: '1.2-2' }}</span>
                            </div>
                        </div>

                        <!-- New Total Payable Box -->
                        <div class="total-payable-box">
                            <div class="flex items-center justify-between">
                                <span class="text-lg font-semibold">Total Payable</span>
                                <span class="text-2xl font-bold">KES {{ premium.totalPayableKES | number: '1.2-2' }}</span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button *ngIf="currentStep === 2" (click)="nextStep()" [disabled]="travelerDetailsForm.invalid || isSaving" class="btn-primary w-full rounded-md px-4 py-3 font-medium">
                                <span *ngIf="!isSaving">Review & Save Quote</span>
                                <span *ngIf="isSaving" class="flex items-center justify-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Saving Quote...
                                </span>
                            </button>
                            <div *ngIf="currentStep === 3" class="flex flex-col gap-3">
                                                                <button (click)="downloadQuote()" class="btn-primary flex w-full items-center justify-center gap-2 rounded-md px-6 py-2 font-medium">
                                    <mat-icon>download</mat-icon>
                                    <span>Download Quote</span>
                                </button>
                                <button (click)="shareQuote()" mat-stroked-button class="w-full rounded-md border-2 border-pantone-light-blue px-6 py-2 font-medium text-pantone-light-blue hover:bg-pantone-light-blue hover:text-white">
                                    <mat-icon class="!h-5 !w-5 !text-base">share</mat-icon>
                                    Share Quote
                                </button>
                                <button (click)="handlePayment()" class="btn-primary rounded-md px-6 py-2 font-medium">Proceed to Payment</button>
                            </div>
                                                          <button (click)="prevStep()" class="mt-4 w-full rounded-md border border-gray-300 px-6 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-100">Back</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div *ngIf="toastMessage" class="fixed bottom-5 right-5 z-50 animate-fade-in-out rounded-lg bg-gray-800 px-5 py-3 text-white shadow-lg transition-opacity duration-300">
    {{ toastMessage }}
</div>