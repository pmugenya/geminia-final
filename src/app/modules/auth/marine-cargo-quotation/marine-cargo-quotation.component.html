<!-- Main container -->
<div class="min-h-screen w-screen bg-gray-50">

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-white shadow-sm">
        <div class="mx-auto max-w-7xl px-4 sm:px-6">
            <div class="flex flex-col items-center justify-between gap-4 py-3 sm:flex-row sm:gap-0 sm:py-4">
                <!-- Logo and Tagline -->
                <div class="flex items-center gap-3 sm:gap-4">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcROTKn0j9cVpA67LPdjPeYBR3KnWiwP1gsM3cS27rca-7m8BgvgUylY4uhBnOnVnXFx8Is&usqp=CAU" alt="Geminia Logo" class="h-8 w-auto sm:h-10" />
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800 sm:text-xl">Geminia Marine</h1>
                        <p class="text-xs font-semibold tracking-wide text-gray-500">Think Insurance ... Think Geminia</p>
                    </div>
                </div>

                <!-- User Info and Actions -->
                <div class="flex flex-wrap items-center justify-center gap-4 sm:flex-nowrap">
                    <!-- Display User Info if Logged In -->
                    <div *ngIf="isLoggedIn" class="flex items-center gap-3 text-sm">
                        <div class="text-right">
                            <span class="font-semibold text-gray-800">{{ user.name }}</span>
                            <span class="block text-xs text-gray-500">{{ user.userType | titlecase }}</span>
                        </div>
                        <button (click)="logout()" class="flex items-center gap-2 rounded-md border border-red-500 bg-red-50 px-3 py-2 text-sm font-medium text-red-600 transition-colors duration-200 hover:bg-red-100" title="Logout">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </button>
                    </div>

                    <!-- Close Button -->
                    <button (click)="closeForm()" class="flex items-center gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors duration-200 hover:bg-gray-50" title="Close">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6 lg:p-8">
        <div class="mx-auto max-w-7xl">
            <!-- Progress Steps -->
            <div class="mb-4 sm:mb-6">
                <div class="flex items-center justify-center space-x-2 sm:space-x-4">
                    <!-- Step 1 Indicator -->
                    <div [class]="currentStep >= 1 ? 'flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-primary text-xs sm:text-sm font-medium text-white' : 'flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-gray-300 text-xs sm:text-sm font-medium text-gray-600'">1</div>
                    <span [class]="currentStep >= 1 ? 'text-xs sm:text-sm font-medium text-primary' : 'text-xs sm:text-sm text-gray-500'" class="hidden sm:inline">Shipment Details</span>
                    <span [class]="currentStep >= 1 ? 'text-xs font-medium text-primary' : 'text-xs text-gray-500'" class="sm:hidden">Details</span>
                    <div class="h-px w-8 sm:w-16 bg-gray-300"></div>
                    <!-- Step 2 Indicator -->
                    <div [class]="currentStep >= 2 ? 'flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-primary text-xs sm:text-sm font-medium text-white' : 'flex h-7 w-7 sm:h-8 sm:w-8 items-center justify-center rounded-full bg-gray-300 text-xs sm:text-sm font-medium text-gray-600'">2</div>
                    <span [class]="currentStep >= 2 ? 'text-xs sm:text-sm font-medium text-primary' : 'text-xs sm:text-sm text-gray-500'" class="hidden sm:inline">Review & Pay</span>
                    <span [class]="currentStep >= 2 ? 'text-xs font-medium text-primary' : 'text-xs text-gray-500'" class="sm:hidden">Review</span>
                </div>
            </div>

            <!-- Form and Summary Grid -->
            <div class="mx-auto max-w-4xl">
                    <!-- Step 1: Details Form -->
                    <div *ngIf="currentStep === 1" class="step-content rounded-lg bg-white p-4 sm:p-6 shadow-sm">
                        <h2 class="mb-2 text-xl sm:text-2xl font-semibold text-gray-900">Marine Cargo Quotation Form</h2>
                        <p class="mb-4 sm:mb-6 text-sm sm:text-base text-gray-600">Complete the details below for your marine cargo insurance quote.</p>

                        <form [formGroup]="quotationForm" (ngSubmit)="onSubmit()">
                            <fieldset [disabled]="showHighRiskModal || showExportModal">

                                <!-- 1. Importer Information Section - Hidden when user is logged in -->
                                <div *ngIf="!user">
                                    <h3 class="mb-3 sm:mb-4 text-lg sm:text-xl font-semibold text-gray-800">Importer Information</h3>
                                    <p class="mb-3 sm:mb-4 text-xs sm:text-sm text-gray-500">This is the person or entity purchasing the insurance policy.</p>
                                    <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4">
                                    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                                        <div><label class="mb-2 block text-base font-medium text-gray-700">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onFirstNameInput($event)" [ngClass]="(quotationForm.get('firstName')?.invalid && quotationForm.get('firstName')?.touched) || !quotationForm.get('firstName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                        <div><label class="mb-2 block text-base font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onLastNameInput($event)" [ngClass]="(quotationForm.get('lastName')?.invalid && quotationForm.get('lastName')?.touched) || !quotationForm.get('lastName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                        <div><label class="mb-2 block text-base font-medium text-gray-700">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 text-base" (keydown)="preventSpaceInEmail($event)" (input)="onEmailInput($event)" autocapitalize="off" autocomplete="email" autocorrect="off" spellcheck="false" inputmode="email" [ngClass]="(quotationForm.get('email')?.invalid && quotationForm.get('email')?.touched) || !quotationForm.get('email')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                                        <div><label class="mb-2 block text-base font-medium text-gray-700">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onPhoneNumberInput($event)" [ngClass]="(quotationForm.get('phoneNumber')?.invalid && quotationForm.get('phoneNumber')?.touched) || !quotationForm.get('phoneNumber')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>

                                    </div>
                                    </div>
                                </div>

                                <!-- 2. Shipment Details Section -->
                                <h3 class="mb-4 mt-6 border-t pt-6 text-xl font-semibold text-gray-800">Shipment Details</h3>
                                <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4">
                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <div>
                                        <label class="mb-2 block text-base font-medium text-gray-700">Mode of Shipment <span class="text-red-500">*</span></label>
                                        <select formControlName="modeOfShipment" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="(quotationForm.get('modeOfShipment')?.invalid && quotationForm.get('modeOfShipment')?.touched) || !quotationForm.get('modeOfShipment')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"><option value="" disabled>Select mode</option><option value="1">Sea</option><option value="2">Air</option></select>
                                    </div>
                                    <div>
                                        <label class="mb-2 block text-base font-medium text-gray-700">Trade Type <span class="text-red-500">*</span></label>
                                        <select formControlName="tradeType" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="(quotationForm.get('tradeType')?.invalid && quotationForm.get('tradeType')?.touched) || !quotationForm.get('tradeType')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"><option value="1">Import</option><option value="2">Export</option></select>
                                    </div>
                                </div>

                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Cargo Protection</label>
                                        <input type="text" formControlName="marineProduct" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 font-bold text-gray-900" readonly/>
                                    </div>
                                    <div>
                                        <label class="mb-2 block text-sm sm:text-base font-medium text-gray-700">Marine Packaging Type <span class="text-red-500">*</span></label>
                                        <div class="rounded-md border p-3 sm:p-4" [ngClass]="(quotationForm.get('marinePackagingType')?.invalid && quotationForm.get('marinePackagingType')?.touched) || !quotationForm.get('marinePackagingType')?.value ? 'border-red-500 bg-red-50' : 'border-gray-300 bg-white'">
                                            <div class="flex flex-col gap-3 md:flex-row md:items-center md:gap-6">
                                                <label class="flex items-center cursor-pointer min-w-0">
                                                    <input type="radio" formControlName="marinePackagingType" value="1" class="h-4 w-4 flex-shrink-0 border-gray-300 text-primary focus:ring-2 focus:ring-blue-500"/>
                                                    <span class="ml-2 text-sm md:text-base text-gray-700">Containerized</span>
                                                </label>
                                                <label class="flex items-center cursor-pointer min-w-0">
                                                    <input type="radio" formControlName="marinePackagingType" value="2" class="h-4 w-4 flex-shrink-0 border-gray-300 text-primary focus:ring-2 focus:ring-blue-500"/>
                                                    <span class="ml-2 text-sm md:text-base text-gray-700">Non-Containerized</span>
                                                </label>
                                            </div>
                                            <p *ngIf="(quotationForm.get('marinePackagingType')?.invalid && quotationForm.get('marinePackagingType')?.touched) || !quotationForm.get('marinePackagingType')?.value" class="mt-2 text-xs sm:text-sm text-red-600 flex items-center">
                                                <svg class="w-4 h-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                                                Please select a packaging type
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <!-- Updated Select Category with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Select Category <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full category-select">
                                            <mat-select formControlName="marineCategory" (selectionChange)="onCategorySelected($event.value)" #categorySelect>
                                                <mat-option>
                                                    <ngx-mat-select-search [formControl]="categoryFilterCtrl" placeholderLabel="Search categories..."></ngx-mat-select-search>
                                                </mat-option>
                                                <mat-option *ngFor="let category of filteredMarineCategories" [value]="category.catname">
                                                    {{ category.catname }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>

                                    <!-- Updated Marine Cargo Type with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Marine Cargo Type <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full cargo-type-select">
                                            <mat-select formControlName="marineCargoType" #cargoTypeSelect [disabled]="isLoadingCargoTypes">
                                                <mat-option>
                                                    <ngx-mat-select-search [formControl]="cargoTypeFilterCtrl" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                                                </mat-option>
                                                <mat-option *ngFor="let type of filteredMarineCargoTypes" [value]="type.ctname">
                                                    {{ type.ctname }}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>
                                </div>

                                <div class="mb-6 grid grid-cols-1 gap-6 md:grid-cols-2">
                                    <!-- Updated Country of Origin with Searchable Dropdown -->
                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Country of Origin <span class="text-red-500">*</span></label>
                                        <mat-form-field appearance="outline" class="w-full country-select">
                                            <mat-select formControlName="origin"
                                                        (openedChange)="onSelectOpen($event)"
                                                        (selectionChange)="onOriginChange($event)"
                                                        (scroll)="onScroll($event)"
                                                        [disabled]="loading">
                                                <div class="search-container" (click)="$event.stopPropagation()">
                                                    <mat-icon>search</mat-icon>
                                                    <input
                                                        matInput
                                                        type="text"
                                                        placeholder="Search..."
                                                        [formControl]="countryFilterCtrl"
                                                        (keydown)="$event.stopPropagation()"
                                                    />
                                                </div>
                                                <mat-option *ngFor="let country of countries" [value]="country.id">
                                                    {{ country.countryname }}
                                                </mat-option>

                                                <!-- Loading indicator -->
                                                <mat-option *ngIf="loading" disabled>
                                                    <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </div>

                                    <div>
                                        <label class="mb-2 block text-sm font-medium text-gray-700">Destination</label>
                                        <input type="text" formControlName="destination" class="w-full rounded-md border-gray-300 bg-gray-100 px-3 py-2 text-gray-900 h-14" readonly/>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <label class="mb-2 block text-sm font-medium text-gray-700">Sum Insured (KES) <span class="text-red-500">*</span></label>
                                    <input type="text" formControlName="sumInsured" appThousands placeholder="2,500,000" inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="(quotationForm.get('sumInsured')?.invalid && quotationForm.get('sumInsured')?.touched) || !quotationForm.get('sumInsured')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/>
                                </div>
                                </div>

                                <!-- Terms and Policy Consent -->
                                <div class="mt-6 space-y-2">
                                    <label class="flex items-start"><input type="checkbox" formControlName="termsAndPolicyConsent" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/><span class="ml-3 text-sm text-gray-700">I agree to the <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a> and to the <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*</span></label>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn-primary mt-8 w-full" [disabled]="isSaving || quotationForm.invalid"><span *ngIf="isSaving" class="animate-spin mr-2 inline-block h-5 w-5 rounded-full border-b-2 border-white"></span>{{ isSaving ? 'Getting Quote...' : 'Get Quote' }}</button>
                            </fieldset>
                        </form>
                    </div>

                    <!-- Step 2: Quote Review & Payment -->
                    <div *ngIf="currentStep === 2" class="step-content space-y-6">
                        <!-- Page Title -->
                        <div class="mb-4 sm:mb-6">
                            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Review Your Quote & Pay</h2>
                        </div>

                        <!-- Quote Details Card -->
                        <div class="rounded-lg border border-gray-200 bg-white p-3 sm:p-4 shadow-sm">
                            <p class="mb-3 sm:mb-4 flex items-center text-sm sm:text-base text-gray-600">
                                <mat-icon class="mr-2 text-blue-600 text-lg sm:text-xl">info</mat-icon>
                                <span class="text-xs sm:text-base">Please confirm the details below before proceeding to payment.</span>
                            </p>

                            <!-- Importer Details Section - Hidden when user is logged in -->
                            <div class="mb-4 sm:mb-6" *ngIf="!user">
                                <h4 class="mb-3 sm:mb-4 text-sm sm:text-base font-bold text-gray-900">Importer Details</h4>
                                <div class="space-y-2 sm:space-y-3">
                                    <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Full Name</span>
                                        <span class="text-xs sm:text-base font-medium text-gray-900 text-right">{{ quotationForm.value.firstName }} {{ quotationForm.value.lastName }}</span>
                                    </div>
                                    <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Email</span>
                                        <span class="text-xs sm:text-base font-medium text-gray-900 text-right break-all">{{ quotationForm.value.email }}</span>
                                    </div>
                                    <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Phone</span>
                                        <span class="text-xs sm:text-base font-medium text-gray-900 text-right">{{ quotationForm.value.phoneNumber }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipment Details Section -->
                            <div>
                                <h4 class="mb-3 sm:mb-4 text-sm sm:text-base font-bold text-gray-900">Shipment Details</h4>
                                <div class="space-y-2 sm:space-y-3">
                                    <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Trade / Cargo Type</span>
                                        <span class="text-xs sm:text-base font-medium text-gray-900 text-right">{{ quotationForm.value.tradeType === '1' ? 'Import' : 'Export' }} / {{ quotationForm.value.marineCargoType | titlecase }}</span>
                                    </div>
                                    <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Origin / Destination</span>
                                        <span class="text-xs sm:text-base font-medium text-gray-900 text-right">{{ selectedCountry | uppercase }} to {{ quotationForm.value.destination | uppercase }}</span>
                                    </div>
                                    <div class="flex justify-between pb-2 sm:pb-3">
                                        <span class="text-xs sm:text-base text-gray-600">Sum Insured [KES]</span>
                                        <span class="text-xs sm:text-base font-bold text-gray-900 text-right">{{ formatAmount(quotationForm.value.sumInsured) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Premium Summary Card -->
                        <div class="rounded-lg border border-gray-200 bg-white p-3 sm:p-4 shadow-sm" *ngIf="quoteResult?.netprem">
                            <h3 class="mb-3 sm:mb-4 text-lg sm:text-xl font-bold text-gray-900">Premium Summary</h3>
                            <div class="space-y-2 sm:space-y-3">
                                <!-- Sum Insured row hidden -->
                                <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                    <span class="text-xs sm:text-base text-gray-600">Basic Premium</span>
                                    <span class="text-xs sm:text-base font-medium text-gray-900 text-right">KES {{ formatAmount(quoteResult.premium) }}</span>
                                </div>
                                <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                    <span class="text-xs sm:text-base text-gray-600">PHCF (0.25%)</span>
                                    <span class="text-xs sm:text-base font-medium text-gray-900 text-right">KES {{ formatAmount(quoteResult.phcf) }}</span>
                                </div>
                                <div class="flex justify-between border-b-2 border-gray-200 pb-2 sm:pb-3">
                                    <span class="text-xs sm:text-base text-gray-600">Training Levy (0.2%)</span>
                                    <span class="text-xs sm:text-base font-medium text-gray-900 text-right">KES {{ formatAmount(quoteResult.tl) }}</span>
                                </div>
                                <div class="flex justify-between pb-2 sm:pb-3">
                                    <span class="text-xs sm:text-base text-gray-600">Stamp Duty<span *ngIf="quotationForm.get('modeOfShipment')?.value !== '2'"> (0.05%)</span></span>
                                    <span class="text-xs sm:text-base font-medium text-gray-900 text-right">KES {{ formatAmount(quoteResult.sd) }}</span>
                                </div>
                            </div>

                            <!-- Total Payable -->
                            <div class="mt-4 sm:mt-6 rounded-lg p-2 sm:p-2.5" style="background-color: #1E90FF;">
                                <div class="flex items-center justify-between text-white">
                                    <span class="text-sm sm:text-base font-bold">Total Payable</span>
                                    <span class="text-base sm:text-xl font-bold">KES {{ quoteResult.netprem | number: '1.2-2' }}</span>
                                </div>
                            </div>

                            <!-- Buy Now Button -->
                            <button (click)="handlePayment()" class="mt-2 sm:mt-3 w-full rounded-lg px-4 sm:px-6 py-2 text-sm sm:text-base font-semibold text-white transition-opacity hover:opacity-90" style="background-color: #00BCD4;">
                                Buy Now
                            </button>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-col gap-3 sm:flex-row sm:justify-between sm:gap-4">
                            <button (click)="goToStep(1)" class="flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium text-gray-700 transition-colors hover:bg-gray-50">
                                <mat-icon class="text-lg sm:text-xl">edit</mat-icon>
                                <span>Back to Edit</span>
                            </button>

                            <div class="flex flex-col gap-3 sm:flex-row sm:gap-4">
                                <button (click)="downloadQuote()" class="flex items-center justify-center gap-2 rounded-lg px-4 sm:px-6 py-2 text-sm sm:text-base font-semibold text-white transition-opacity hover:opacity-90" style="background-color: #00BCD4;">
                                    <mat-icon class="text-lg sm:text-xl">download</mat-icon>
                                    <span>Download Quote</span>
                                </button>
                                <button (click)="shareQuote()" class="flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base font-medium text-gray-700 transition-colors hover:bg-gray-50">
                                    <mat-icon class="text-lg sm:text-xl">share</mat-icon>
                                    <span>Share Quote</span>
                                </button>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </main>

    <!-- REFACTORED MODALS SECTION (Export/High Risk) -->
    <div *ngIf="showExportModal || showHighRiskModal" (click)="closeAllModals()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[95vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white p-1 shadow-xl">
            <div class="p-7">
                <h2 class="mb-4 text-2xl font-bold">{{ showExportModal ? 'Export Shipment Details' : 'High-Risk Shipment Details' }}</h2>
                <p class="mb-6 text-gray-600">{{ showExportModal ? 'Please provide the following details for your export request.' : 'Shipments from this origin require manual underwriting. Please provide your details to proceed.' }}</p>

                <form [formGroup]="showExportModal ? exportRequestForm : highRiskRequestForm" (ngSubmit)="showExportModal ? onExportRequestSubmit() : onHighRiskRequestSubmit()">
                    <div class="grid grid-cols-1 gap-x-6 gap-y-4 md:grid-cols-2">
                        <!-- Personal Information -->
                        <div><label class="mb-2 block text-base font-medium">First Name <span class="text-red-500">*</span></label><input type="text" formControlName="firstName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalFirstNameInput($event, showExportModal ? 'export' : 'highRisk')" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('firstName')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('firstName')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('firstName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                        <div><label class="mb-2 block text-base font-medium">Last Name <span class="text-red-500">*</span></label><input type="text" formControlName="lastName" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalLastNameInput($event, showExportModal ? 'export' : 'highRisk')" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('lastName')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('lastName')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('lastName')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                        <div><label class="mb-2 block text-base font-medium">Email Address <span class="text-red-500">*</span></label><input type="email" formControlName="email" class="w-full rounded-md border bg-white px-3 py-2 text-base" (keydown)="preventSpaceInEmail($event)" (input)="onModalEmailInput($event, showExportModal ? 'export' : 'highRisk')" autocapitalize="off" autocomplete="email" autocorrect="off" spellcheck="false" inputmode="email" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('email')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('email')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('email')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>
                        <div><label class="mb-2 block text-base font-medium">Phone Number <span class="text-red-500">*</span></label><input type="tel" formControlName="phoneNumber" class="w-full rounded-md border bg-white px-3 py-2 text-base" (input)="onModalPhoneNumberInput($event, showExportModal ? 'export' : 'highRisk')" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('phoneNumber')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/></div>

                        <!-- Shipment Information -->
                        <div>
                            <label class="mb-2 block text-base font-medium">Country of Origin <span class="text-red-500">*</span></label>
                            <input *ngIf="showExportModal" type="text" formControlName="originCountry" class="w-full rounded-md border bg-gray-100 px-3 py-2 text-base font-semibold text-gray-700" readonly/>
                            <select *ngIf="!showExportModal" formControlName="originCountry" class="w-full rounded-md border bg-white px-3 py-2 text-base font-semibold" [ngClass]="(highRiskRequestForm.get('originCountry')?.invalid && highRiskRequestForm.get('originCountry')?.touched) || !highRiskRequestForm.get('originCountry')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'">
                                <option value="" disabled>Select a country</option>
                                <option *ngFor="let country of allCountriesList" [value]="country">{{ country }}</option>
                            </select>
                        </div>

                        <div>
                            <label class="mb-2 block text-base font-medium">Destination Country <span class="text-red-500">*</span></label>
                            <!-- Input for High Risk Modal -->
                            <input *ngIf="!showExportModal" type="text" formControlName="destinationCountry" class="w-full rounded-md border bg-gray-100 px-3 py-2 text-base font-bold text-gray-900" readonly/>
                            <!-- Select for Export Modal -->
                            <select *ngIf="showExportModal" formControlName="destinationCountry" class="w-full rounded-md border bg-white px-3 py-2 text-base font-semibold" [ngClass]="(exportRequestForm.get('destinationCountry')?.invalid && exportRequestForm.get('destinationCountry')?.touched) || !exportRequestForm.get('destinationCountry')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'">
                                <option value="" disabled>Select a country</option>
                                <option *ngFor="let country of exportDestinationCountries" [value]="country">{{ country }}</option>
                            </select>
                        </div>

                        <div>
                            <label class="mb-2 block text-base font-medium">Shipment Date <span class="text-red-500">*</span></label>
                            <mat-form-field appearance="outline" class="w-full" style="font-size: 16px;"
                                            [ngClass]="{'mat-form-field-invalid': ((showExportModal ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('shipmentDate')?.value}">
                                <input matInput [matDatepicker]="shipmentPicker" formControlName="shipmentDate" [min]="minDate" readonly>
                                <mat-datepicker-toggle matSuffix [for]="shipmentPicker"></mat-datepicker-toggle>
                                <mat-datepicker #shipmentPicker></mat-datepicker>
                            </mat-form-field>
                        </div>

                        <div>
                            <label class="mb-2 block text-base font-medium">Sum Insured (KES) <span class="text-red-500">*</span></label>
                            <input type="text" formControlName="sumInsured" appThousands placeholder="e.g., 1,500,000" inputmode="numeric" class="w-full rounded-md border bg-white px-3 py-2 text-base" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('sumInsured')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"/>
                        </div>

                        <div class="md:col-span-2">
                            <label class="mb-2 block text-base font-medium">Goods Description (Max 100 words) <span class="text-red-500">*</span></label>
                            <textarea formControlName="goodsDescription" rows="3" placeholder="Describe the goods being shipped..." class="w-full rounded-md border bg-white px-3 py-2 text-base" style="min-height: 80px;" (blur)="trimInput($event, 'goodsDescription', showExportModal ? 'export' : 'highRisk')" [ngClass]="((showExportModal ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.invalid && (showExportModal ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.touched) || !(showExportModal ? exportRequestForm : highRiskRequestForm).get('goodsDescription')?.value ? 'border-red-500 focus:ring-2 focus:ring-red-500' : 'border-gray-300 focus:ring-2 focus:ring-blue-500'"></textarea>
                        </div>
                    </div>

                    <div class="mt-6 space-y-2">
                        <label class="flex items-start"><input type="checkbox" formControlName="termsAndPolicyConsent" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus-ring-primary"/><span class="ml-3 text-sm text-gray-700">I agree to the <a (click)="openTermsModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Terms of Use</a> and to the <a (click)="openPrivacyModal($event)" class="cursor-pointer font-medium text-primary hover:underline">Data Privacy Policy</a>.*</span></label>
                    </div>
                    <div class="mt-8 flex justify-end gap-4 border-t pt-6">
                        <button type="button" (click)="closeAllModals()" class="rounded-md border border-gray-300 px-4 py-2 hover:bg-gray-50">Cancel</button>
                        <button type="submit" [disabled]="(showExportModal ? exportRequestForm : highRiskRequestForm).invalid" class="btn-primary">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Terms of Use Modal -->
    <div *ngIf="showTermsModal" (click)="closeTermsModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-lg bg-white shadow-xl">
            <div class="sticky top-0 border-b bg-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Terms of Use</h2>
                    <button (click)="closeTermsModal()" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>
            <div class="p-6">
                <div class="prose max-w-none text-gray-700">
                    <h3 class="mb-4 text-lg font-semibold">Terms of Use and Data Privacy Policy</h3>
                    <p class="mb-4">Geminia Insurance Company Limited is committed to protecting the fundamental human right to privacy of those with whom we interact. We recognize the need to safeguard personal data that is collected or disclosed to us as part of the Know-your-customer information required by us in order to provide you with the requisite financial product or service.</p>
                    <p class="mb-4">We are committed to complying with the requirements of the Data Protection Act and the attendant regulations as well as best global best practices regarding the processing of your personal data. In this regard, you are required to acquaint yourselves with our data privacy statement which is intended to tell you how we use your personal data and describes how we collect and process your personal data during and after your relationship.</p>
                    <div class="mt-6 rounded-lg bg-blue-50 p-4"><p class="text-sm text-blue-800"><strong>External Link:</strong> For complete terms and conditions, please visit: <a href="https://geminia.co.ke/data-privacy-statement/" target="_blank" class="ml-1 font-medium text-blue-600 hover:underline">https://geminia.co.ke/data-privacy-statement/</a></p></div>
                </div>
                <div class="mt-8 flex justify-end border-t pt-4"><button (click)="closeTermsModal()" class="btn-primary">I Understand</button></div>
            </div>
        </div>
    </div>

    <!-- Data Privacy Policy Modal -->
    <div *ngIf="showPrivacyModal" (click)="closePrivacyModal()" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4">
        <div (click)="$event.stopPropagation()" class="max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-lg bg-white shadow-xl">
            <div class="sticky top-0 border-b bg-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900">Data Privacy Policy</h2>
                    <button (click)="closePrivacyModal()" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>
            <div class="p-6">
                <div class="prose max-w-none text-gray-700">
                    <h3 class="mb-4 text-lg font-semibold">Data Privacy Statement</h3>
                    <p class="mb-4">Geminia Insurance Company Limited is committed to protecting the fundamental human right to privacy of those with whom we interact. We recognize the need to safeguard personal data that is collected or disclosed to us as part of the Know-your-customer information required by us in order to provide you with the requisite financial product or service.</p>
                    <p class="mb-4">We are committed to complying with the requirements of the Data Protection Act and the attendant regulations as well as best global best practices regarding the processing of your personal data. In this regard, you are required to acquaint yourselves with our data privacy statement which is intended to tell you how we use your personal data and describes how we collect and process your personal data during and after your relationship.</p>
                    <div class="mt-6 rounded-lg bg-green-50 p-4"><p class="text-sm text-green-800"><strong>External Link:</strong> For complete privacy policy details, please visit: <a href="https://geminia.co.ke/data-privacy-statement/" target="_blank" class="ml-1 font-medium text-green-600 hover:underline">https://geminia.co.ke/data-privacy-statement/</a></p></div>
                </div>
                <div class="mt-8 flex justify-end border-t pt-4"><button (click)="closePrivacyModal()" class="btn-primary">I Understand</button></div>
            </div>
        </div>
    </div>

    <!-- Universal Toast Message -->
    <div *ngIf="toastMessage" class="animate-fade-in-out fixed bottom-5 right-5 z-50 rounded-lg bg-gray-800 px-5 py-3 text-white shadow-lg transition-opacity duration-300">{{ toastMessage }}</div>

</div>
